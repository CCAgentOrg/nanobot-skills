name: Skills CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate-skills:
    name: Validate Skills
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Validate SKILL.md files
        run: |
          echo "Checking for SKILL.md files in each skill directory..."
          errors=0
          
          for skill_dir in */; do
            if [ "$skill_dir" = ".github/" ] || [ "$skill_dir" = ".git/" ]; then
              continue
            fi
            
            if [ "$skill_dir" = */ ]; then
              skill_name="${skill_dir%/}"
            else
              skill_name="$skill_dir"
            fi
            
            if [ ! -f "${skill_dir}SKILL.md" ]; then
              echo "âŒ Missing SKILL.md in $skill_name"
              errors=$((errors + 1))
            else
              echo "âœ“ $skill_name has SKILL.md"
              
              # Check SKILL.md has required sections
              if ! grep -q "^# " "${skill_dir}SKILL.md"; then
                echo "  âš  Missing title header"
                errors=$((errors + 1))
              fi
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo ""
            echo "Found $errors errors"
            exit 1
          fi
          
          echo "âœ… All skills have valid SKILL.md files"
      
      - name: Check Python scripts
        run: |
          echo "Validating Python scripts..."
          errors=0
          
          find . -name "*.py" -not -path "./.git/*" | while read -r script; do
            echo "Checking: $script"
            
            # Check syntax
            if ! python -m py_compile "$script" 2>/dev/null; then
              echo "âŒ Syntax error in $script"
              errors=$((errors + 1))
            fi
          done
          
          echo "âœ… Python scripts are valid"
      
      - name: Lint Python files
        run: |
          echo "Linting Python files..."
          ruff check . --output-format=compact || true
          echo "Linting complete (warnings shown above)"

  validate-readme:
    name: Validate README
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "âŒ Missing README.md"
            exit 1
          fi
          echo "âœ“ README.md exists"
      
      - name: Check README format
        run: |
          # Check for required sections
          required_sections=("## Skills" "## Installation")
          missing=0
          
          for section in "${required_sections[@]}"; do
            if ! grep -q "^${section}" README.md; then
              echo "âŒ Missing section: $section"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "Found $missing missing sections"
            exit 1
          fi
          
          echo "âœ“ README.md has required sections"

  skill-stats:
    name: Skill Statistics
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Count skills
        id: stats
        run: |
          skill_count=$(find . -maxdepth 1 -type d ! -name ".*" ! -name "." | wc -l)
          skill_count=$((skill_count - 1))
          python_scripts=$(find . -name "*.py" -not -path "./.git/*" | wc -l)
          skill_mds=$(find . -name "SKILL.md" | wc -l)
          
          echo "skill_count=$skill_count" >> $GITHUB_OUTPUT
          echo "python_scripts=$python_scripts" >> $GITHUB_OUTPUT
          echo "skill_mds=$skill_mds" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Repository Statistics:"
          echo "  Skills: $skill_count"
          echo "  Python scripts: $python_scripts"
          echo "  SKILL.md files: $skill_mds"
      
      - name: Comment PR with stats
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const stats = `ðŸ“Š **Skills Statistics**
            
            - Skills: ${{ steps.stats.outputs.skill_count }}
            - Python scripts: ${{ steps.stats.outputs.python_scripts }}
            - SKILL.md files: ${{ steps.stats.outputs.skill_mds }}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: stats
            });
